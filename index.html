<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Imports</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="CPSC330_blog_files/libs/clipboard/clipboard.min.js"></script>
<script src="CPSC330_blog_files/libs/quarto-html/quarto.js"></script>
<script src="CPSC330_blog_files/libs/quarto-html/popper.min.js"></script>
<script src="CPSC330_blog_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CPSC330_blog_files/libs/quarto-html/anchor.min.js"></script>
<link href="CPSC330_blog_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CPSC330_blog_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CPSC330_blog_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CPSC330_blog_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CPSC330_blog_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Imports</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="d797382f-f538-4c1e-b6a6-6f42e838d655" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hashlib <span class="im">import</span> sha1</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"font.size"</span>] <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.dummy <span class="im">import</span> DummyClassifier</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> CountVectorizer</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> (</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    GridSearchCV,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    cross_val_score,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    cross_validate,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    train_test_split,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline, make_pipeline</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer, make_column_transformer</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score, cross_validate, train_test_split</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, StandardScaler, OrdinalEncoder</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVC</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> RFE</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> RandomizedSearchCV</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="will-they-pay" class="level1">
<h1>Will They Pay?</h1>
<section id="predicting-credit-card-client-defaults" class="level2">
<h2 class="anchored" data-anchor-id="predicting-credit-card-client-defaults">Predicting Credit Card Client Defaults</h2>
<p><span style="font-size: 20px;">By Rachel Xu</span></p>
<p>In the credit card industry, the relationship between the company and the client is built on trust. Whether or not a client will pay their bills on time is a risk the company must take—a risk that, if handled poorly, can lead to tremendous financial losses.</p>
<p>In today’s modern age, we have the advantage of machine learning to help address this challenge. In this project, I aim to classify whether a client is likely to default their credit card bills based on patterns and characteristics of customer behavior. The findings of this study may provide valuable insights to credit card companies, helping them establish more stable and stronger relationships with clients while minimizing financial losses.</p>
<section id="dataset-overview" class="level3">
<h3 class="anchored" data-anchor-id="dataset-overview">Dataset Overview</h3>
<p>For this project, I am using the <a href="https://www.kaggle.com/datasets/uciml/default-of-credit-card-clients-dataset">Default of Credit Card Clients Dataset</a>. This dataset contains 30,000 credit card client examples with 25 features, such as the client’s age, payment and bill history, and education. I will be using this data to predict whether a client will default their credit card bills.</p>
<p>The first few rows of the dataset are shown below, with a brief description of its features:</p>
<div id="77ced2e8-277b-4343-a048-9fc42e075cbf" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>cc_df <span class="op">=</span> pd.read_csv(<span class="st">"data/UCI_Credit_Card.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cc_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ID</th>
<th data-quarto-table-cell-role="th">LIMIT_BAL</th>
<th data-quarto-table-cell-role="th">SEX</th>
<th data-quarto-table-cell-role="th">EDUCATION</th>
<th data-quarto-table-cell-role="th">MARRIAGE</th>
<th data-quarto-table-cell-role="th">AGE</th>
<th data-quarto-table-cell-role="th">PAY_0</th>
<th data-quarto-table-cell-role="th">PAY_2</th>
<th data-quarto-table-cell-role="th">PAY_3</th>
<th data-quarto-table-cell-role="th">PAY_4</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">BILL_AMT4</th>
<th data-quarto-table-cell-role="th">BILL_AMT5</th>
<th data-quarto-table-cell-role="th">BILL_AMT6</th>
<th data-quarto-table-cell-role="th">PAY_AMT1</th>
<th data-quarto-table-cell-role="th">PAY_AMT2</th>
<th data-quarto-table-cell-role="th">PAY_AMT3</th>
<th data-quarto-table-cell-role="th">PAY_AMT4</th>
<th data-quarto-table-cell-role="th">PAY_AMT5</th>
<th data-quarto-table-cell-role="th">PAY_AMT6</th>
<th data-quarto-table-cell-role="th">default.payment.next.month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>20000.0</td>
<td>2</td>
<td>2</td>
<td>1</td>
<td>24</td>
<td>2</td>
<td>2</td>
<td>-1</td>
<td>-1</td>
<td>...</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>689.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>120000.0</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>26</td>
<td>-1</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>3272.0</td>
<td>3455.0</td>
<td>3261.0</td>
<td>0.0</td>
<td>1000.0</td>
<td>1000.0</td>
<td>1000.0</td>
<td>0.0</td>
<td>2000.0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>90000.0</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>34</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>14331.0</td>
<td>14948.0</td>
<td>15549.0</td>
<td>1518.0</td>
<td>1500.0</td>
<td>1000.0</td>
<td>1000.0</td>
<td>1000.0</td>
<td>5000.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>50000.0</td>
<td>2</td>
<td>2</td>
<td>1</td>
<td>37</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>28314.0</td>
<td>28959.0</td>
<td>29547.0</td>
<td>2000.0</td>
<td>2019.0</td>
<td>1200.0</td>
<td>1100.0</td>
<td>1069.0</td>
<td>1000.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>50000.0</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>57</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>20940.0</td>
<td>19146.0</td>
<td>19131.0</td>
<td>2000.0</td>
<td>36681.0</td>
<td>10000.0</td>
<td>9000.0</td>
<td>689.0</td>
<td>679.0</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>5 rows × 25 columns</p>
</div>
</div>
</div>
<p><strong>ID</strong>: ID of each client <br> <strong>LIMIT_BAL</strong>: Amount of given credit in NT dollars <br> <strong>SEX</strong>: Gender (1=male, 2=female) <br> <strong>EDUCATION</strong>: (1=graduate school, 2=university, 3=high school, 4=others, 5=unknown, 6=unknown) <br> <strong>MARRIAGE</strong>: Marital status (1=married, 2=single, 3=others) <br> <strong>AGE</strong>: Age in years <br> <strong>PAY_0 to PAY_6</strong>: Repayment status from April, 2005 to September, 2005 (-1=pay duly, 1=payment delay for one month, 2=payment delay for two months, … 8=payment delay for eight months, 9=payment delay for nine months and above) <br> <strong>BILL_AMT1 to BILL_AMT6</strong>: Amount of bill statement from April, 2005 to September, 2005 (NT dollar) <br> <strong>PAY_AMT1 to PAY_AMT6</strong>: Amount of previous payment from April, 2005 to September, 2005 (NT dollar) <br> <strong>default.payment.next.month</strong>: Default payment (1=yes, 0=no)</p>
<p>The project’s prediction target is the “default.payment.next.month” column, where a prediction of <strong>1</strong> means the client will fail to pay their credit card bills next month, and a prediction of <strong>0</strong> means the client will make their payment on time. <br> The default.payment.next.month chart below provides a quick visualization of the target variable. This chart illustrates that there is a significantly higher number of clients who did not default on their bills than those who did, which is something to keep in mind.</p>
<div id="1b6a0124-1310-4e4a-bc67-a986e10f6393" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>value_counts <span class="op">=</span> cc_df[<span class="st">"default.payment.next.month"</span>].value_counts()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>value_counts.plot(kind<span class="op">=</span><span class="st">'bar'</span>, color<span class="op">=</span>[<span class="st">'lightblue'</span>, <span class="st">'pink'</span>])</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Default Payment Next Month'</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Payment Status'</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Number of Clients'</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>plt.xticks([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="st">'No Default'</span>, <span class="st">'Default'</span>], rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://raw.githubusercontent.com/RachelX6/Predict-Credit-Card-Client-Defaults/main/CreditClientDefault_files/figure-html/cell-8-output-1.png" alt="Image 1"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="phases-of-the-project" class="level2">
<h2 class="anchored" data-anchor-id="phases-of-the-project">Phases of the Project</h2>
<p>The project was divided into several steps in order to arrive at the final results: 1. Preparing the Data 2. Choosing Models 3. Tuning and Improving the Models 4. Testing the Model 5. Results, Summary &amp; Caveats</p>
<section id="preparing-the-data" class="level4">
<h4 class="anchored" data-anchor-id="preparing-the-data">Preparing the Data</h4>
<p>Before building the predictive model, I first analyzed and organized to make it more efficient and easier to work with. This includes visualizing the data through graphs and identifying any potential relationships between different features and how they may relate to the target variable, default.payment.next.month. I also sorted the features of the data into groups based on their properties (e.g., numerical, categorical, etc.), and adjusted them into a format where they can be easily understood and processed by the model.</p>
</section>
<section id="choosing-models" class="level4">
<h4 class="anchored" data-anchor-id="choosing-models">Choosing Models</h4>
<p>I tested several machine learning models to find the one that would lead to the best predictive results for this project. The models I tried include: * Dummy Classifier * Logistic Regression * Decision Tree Classifier * K-Nearest Neighbors Classifier * Random Forest Classifier</p>
<p>I chose to test a variety of models for this project because each model functions differently and uniquely. Some models perform better on data that exhibits a linear pattern (such as logistic regression), while others excel more with non-linear data. In order to assess their performance, I used methods like cross-validation to gauge how well they predicted the default.payment.next.month variable. Through this, I was able to gain some insight on which models might perform the best for this study. This is just a preliminary step, though, as additional work and model tuning could change the outcomes.</p>
</section>
<section id="tuning-and-improving-the-models" class="level4">
<h4 class="anchored" data-anchor-id="tuning-and-improving-the-models">Tuning and Improving the Models</h4>
<p>Next, I focused on fine-tuning the model to maximize its performance for predicting whether a client would default on their credit card payments.</p>
<p><span style="font-size: 16px;">Selecting Most Relevant Features</span></p>
<p>To start, I first determined which features have the most impact on whether a client defaults or not. This would help me understand the significance of different features and maybe eliminate any unecessary ones. For this feature selection, I used RFECV, and the most relevant features I found were PAY_0, PAY_3, BILL_AMT1, BILL_AMT2, and PAY_AMT1. <br> Below, I have plotted graphs displaying these five features, with each feature separated into two groups based on whether the client defaulted or not. Some examples of ways to interpret them are below: * larger values of repayment delay (PAY_0 and PAY_3) are more likely to show up for clients who defaulted, compared to those who did not. * clients with larger bills to pay (BILL_AMT1 and BILL_AMT2) are more likely to default than those who do not.</p>
<p>With this, it appears that the client’s bill amount and payment history are heavily related to whether or not they paid their credit card bill the next month, which makes sense. <br></p>
<div id="219ec28d-1018-4802-809e-c9b54989447b" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [<span class="st">"PAY_0"</span>, <span class="st">"PAY_3"</span>, <span class="st">"BILL_AMT1"</span>, <span class="st">"BILL_AMT2"</span>, <span class="st">"PAY_AMT1"</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>num_cols <span class="op">=</span> <span class="dv">3</span>  </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>n_rows <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(n_rows, num_cols, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, feat <span class="kw">in</span> <span class="bu">enumerate</span>(feats):</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    cc_df.groupby(<span class="st">"default.payment.next.month"</span>)[feat].plot.hist(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        density<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Histogram of "</span> <span class="op">+</span> feat,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(feat)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">"Histogram of "</span> <span class="op">+</span> feat)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>fig.delaxes(axes[<span class="dv">5</span>])</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CPSC330_blog_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I then tested the model using only these five features, but since the accuracy of the model’s prediction did not seem to show much improvement, I decided to stick with using the original full set of features. However, this step was still useful as it provided a more in-depth understanding of the features and their relation to the target variable.</p>
<p><span style="font-size: 16px;">Tuning Model’s Hyperparameters</span></p>
<p>The next step was to make sure that the model performs to the best of its capabilities for this dataset. To do this, I adjusted the specific factors of the model, called hyperparameters, and tested several different combinations of these factors to find the one that resulted in the most accurate predictions. I applied this procedure for: Logistic Regression, DecisionTreeClassifier, K-Nearest Neighbors Classifier, and Random Forest Classifier. I did not do this tuning for the Dummy Classifier due to its poor initial performance. When a model had two or more hyperparameters to tune, I used GridSearchCV and RandomSearchCV, which find the best combination of hyperparameters by testing different values that I provide. For models that only had one hyperparameter to tune, I tested a large range of values using a loop.</p>
<p>After tuning all the models, the model with the highest accuracy and most stable cross-validation scores was the Random Forest Classifier. Hence, I chose it as the final model for this project. <br> For those interested in more detail, I have included the code below that demonstrates the hyperparameter tuning process of the RandomForestClassifier final model. It outputs the combination of the hyperparameters that leads to the highest predictive accuracy (n_estimators = 120, max_features = log2, and max_depth = 10), as well as the accuracy itself, which is 0.8195 or 81.95%. It is worth noting that this accuracy only reflects how well the model is performing during the tuning and improvement stage. The actual accuracy when the model is used on data it has not seen before may vary.</p>
<div id="6390de81-a536-4a43-9af9-4e867764cfad" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>train_df, test_df <span class="op">=</span> train_test_split(cc_df, test_size <span class="op">=</span> <span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="st">"default.payment.next.month"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> train_df.drop(columns <span class="op">=</span> [target])</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> train_df[target]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> test_df.drop(columns <span class="op">=</span> [target])</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> test_df[target]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2ee059fa-0677-4d21-9786-c08f97973f9c" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>param_grid_rf <span class="op">=</span> {<span class="st">"n_estimators"</span>: [<span class="dv">1</span>,<span class="dv">50</span>,<span class="dv">100</span>,<span class="dv">120</span>,<span class="dv">200</span>],</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"max_depth"</span>: [<span class="va">None</span>, <span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"max_features"</span>: [<span class="st">"sqrt"</span>, <span class="st">"log2"</span>, <span class="va">None</span>]}</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>rf_opt <span class="op">=</span> RandomForestClassifier(random_state <span class="op">=</span> <span class="dv">123</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>rf_search <span class="op">=</span> RandomizedSearchCV(rf_opt, param_grid_rf, n_iter <span class="op">=</span> <span class="dv">100</span>, n_jobs <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>, random_state <span class="op">=</span> <span class="dv">123</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>rf_search.fit(X_train, y_train)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>rf_best_params <span class="op">=</span> rf_search.best_params_</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>rf_best_score <span class="op">=</span> rf_search.best_score_</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rf_best_params)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rf_best_score)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'n_estimators': 120, 'max_features': 'log2', 'max_depth': 10}
0.8195238095238097</code></pre>
</div>
</div>
</section>
<section id="testing-the-model" class="level4">
<h4 class="anchored" data-anchor-id="testing-the-model">Testing the Model</h4>
<p>In this stage of the project, I tested my final Random Forest Classifier model on data it had not seen before. This assesses how well the model will perform in the “real world” when it deals with new data. Using a subset of the <a href="https://www.kaggle.com/datasets/uciml/default-of-credit-card-clients-dataset">Default of Credit Card Clients Dataset</a> that was not used to build the model, the following are the statistics of the model’s performance on new data.</p>
<p>The model achieved an <strong>accuracy score of 0.82222</strong>, meaning it was able to correctly predict 82.22% of the clients to whether or not they defaulted on their credit card bills the following month.</p>
<p>When the model predicted that the client would default, it was correct 65.85% of the time.</p>
<p>Furthermore, out of all the clients who defaulted, the model correctly identified 37.11% of them while it failed to identify 62.89% of them.</p>
<p>Regarding the balance between the model’s predictions and its errors, the model achieved a score of 47.47%.</p>
<p>Below, I have included a confusion matrix illustrating the model’s predictions of default.payment.next.month for clients in the unseen data. The model made 6677 correct predictions and 375 incorrect predictions for non-defaulting clients. The model predicted 723 correct predictions and 1225 incorrect predictions for defaulting clients. These values align with the statistics presented above.</p>
<div id="64780a66-1099-4df6-846e-34001094348d" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rf_final <span class="op">=</span> RandomForestClassifier(random_state <span class="op">=</span> <span class="dv">123</span>, n_estimators <span class="op">=</span> <span class="dv">120</span>, max_features <span class="op">=</span> <span class="st">"log2"</span>, max_depth <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>rf_final.fit(X_train, y_train)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> rf_final.predict(X_test)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="op">=</span> confusion_matrix(y_test, predictions)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>sns.heatmap(conf_matrix, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"RdPu"</span>, </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            xticklabels<span class="op">=</span>[<span class="st">'No Default'</span>, <span class="st">'Default'</span>], </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            yticklabels<span class="op">=</span>[<span class="st">'No Default'</span>, <span class="st">'Default'</span>])</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Model Prediction'</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Actual Default Status'</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Model Predictions vs Actual Default Status'</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CPSC330_blog_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="results-summary-caveats" class="level4">
<h4 class="anchored" data-anchor-id="results-summary-caveats">Results, Summary &amp; Caveats</h4>
<p>After testing the Random Forest Classifier model on unseen data, the accuracy score increased to 82.22%, up from 81.95%. The similarity in the two accuracy scores suggests that the model is performing consistently and in parallel to how we expected it to when used on new examples of clients. <br> However, the high accuracy score may be misleading. From the statistics above, the model only correctly identified clients who defaulted on their credit card bills 37.11% of the time. This is quite a disappointing result. Some potential reasons for this may be due to class imbalance, which was brought up at the beginning of this project. Since there are significantly more examples of non-defaulting clients in the dataset, the high accuracy may be from the model correctly predicting clients who did not default, but less of those who did default. Hence, to work to overcome this, I plan to explore methods that minimize class imbalance and see if it improves the model’s overall performance. <br> Another reason for the model’s inaccurate predictions could be that it is unable to fully capture the relationships between features and within the data, making it difficult to take them into account when predicting new data. In other words, the model’s ability to generalize on this dataset may be limited, and it may struggle to capture all its complex characteristics. <br> Lastly, although the Random Forest Classifier model performed well and consistently during both the building and testing phases, there still remains a risk of overfitting. Since the Random Forest Classifier was built with a large number of features in consideration, the model would be very complex. This would cause the model to learn very specific details or patterns based on the data it was built with, patterns that are less applicable to new data.</p>
</section>
</section>
<section id="my-takeaway" class="level2">
<h2 class="anchored" data-anchor-id="my-takeaway">My Takeaway</h2>
<p>Exploring the field of machine learning through this project and applying the lessons that I learned in class to a practical real-world scenario has been an incredibly engaging and enlightening journey. This project deepened my understanding of many of the concepts I have been learning, from broad topics such as the methods used to build the best model, to more specific ones like using RFECV and creating different types of graphs for various uses. I have also discovered many more areas of interest, such as addressing class imbalance and experimenting with more complex models, and I am excited to continue exploring these topics and intrigued to see what else can be accomplished.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>
